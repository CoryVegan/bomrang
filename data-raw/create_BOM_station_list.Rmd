---
title: "Get BOM Stations"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document provides details on methods used to create the database of BOM JSON files for stations and corresponding metadata, e.g., latitude, longitude (which are more detailed than what is in the JSON file), start, end, elevation, etc.

Refer to these BOM pages for more reference:  
- http://www.bom.gov.au/inside/itb/dm/idcodes/struc.shtml  
- http://reg.bom.gov.au/catalogue/data-feeds.shtml  
- http://reg.bom.gov.au/catalogue/anon-ftp.shtml  
- http://www.bom.gov.au/climate/cdo/about/site-num.shtml  

## Product code definitions
### States
- IDD - NT  
- IDN - NSW/ACT  
- IDQ - Qld
- IDS - SA  
- IDT - Tas/Antarctica (distinguished by the product number)
- IDV - Vic  
- IDW - WA  

### Product code numbers
- 60701 - coastal observations (duplicated in 60801)  
- 60801 - all weather observations (we will use this)  
- 60803 - Antarctica weather observations (and use this, this distinguishes Tas from Antarctica)  
- 60901 - capital city weather observations (duplicated in 60801)  
- 60903 - Canberra area weather observations (duplicated in 60801)  

## Get station metadata

```{r get_bom_station_data, eval=TRUE}
library(dplyr)
library(readr)

# This file is a pseudo-fixed width file. Line five contains the headers at
# fixed widths which are coded in the read_table() call.
# The last six lines contain other information that we don't want.
# For some reason, reading it directly from the BOM website does not work, so
# we use download.file to fetch it first and then import it from the R tempdir()

download.file(
"ftp://ftp.bom.gov.au/anon2/home/ncc/metadata/sitelists/stations.zip",
paste0(tempdir(), "stations.zip")
)

bom_stations_raw <-
  read_table(
  paste0(tempdir(), "stations.zip"),
  skip = 5,
  guess_max = 20000,
  col_names = c(
  "site",
  "dist",
  "NAME",
  "start",
  "end",
  "Lat",
  "Lon",
  "source",
  "state",
  "height",
  "bar_ht",
  "WMO"
  ),
  col_types = cols(
  site = col_character(),
  dist = col_character(),
  NAME = col_character(),
  start = col_integer(),
  end = col_integer(),
  Lat = col_double(),
  Lon = col_double(),
  source = col_character(),
  state = col_character(),
  height = col_double(),
  bar_ht = col_double(),
  WMO = col_integer()
  ),
  na = c("..")
  )

# trim the end of the rows off that have extra info that's not in columns
nrows <- nrow(bom_stations_raw) - 5
bom_stations_raw <- bom_stations_raw[1:nrows,]

# recode the states to match product codes
# IDD - NT, IDN - NSW/ACT, IDQ - Qld, IDS - SA, IDT - Tas/Antarctica, IDV - Vic, IDW - WA

bom_stations_raw$state_code <- NA
bom_stations_raw$state_code[bom_stations_raw$state == "WA"] <-
"W"
bom_stations_raw$state_code[bom_stations_raw$state == "QLD"] <-
"Q"
bom_stations_raw$state_code[bom_stations_raw$state == "VIC"] <-
"V"
bom_stations_raw$state_code[bom_stations_raw$state == "NT"] <-
"D"
bom_stations_raw$state_code[bom_stations_raw$state == "TAS" |
bom_stations_raw$state == "ANT"] <-
"T"
bom_stations_raw$state_code[bom_stations_raw$state == "NSW"] <-
"N"
bom_stations_raw$state_code[bom_stations_raw$state == "SA"] <-
"S"

# create JSON URLs
bom_stations_raw$url <- NA

bom_stations_raw <-
bom_stations_raw %>%
mutate(url = case_when(
.$state != "ANT" & !is.na(.$WMO) ~
paste0(
"http://www.bom.gov.au/fwo/ID",
.$state_code,
"60801",
"/",
"ID",
.$state_code,
"60801",
".",
.$WMO,
".json"
),
.$state == "ANT" & !is.na(.$WMO) ~
paste0(
"http://www.bom.gov.au/fwo/ID",
.$state_code,
"60803",
"/",
"ID",
.$state_code,
"60803",
".",
.$WMO,
".json"
)
))

bom_stations_raw
```
## Save station metadata
Now that we have the dataframe of stations and have generated the URLs for the JSON files for stations providing weather data feeds, save the
data as a database for _bomrang_ to use.

```{r save_data, eval=TRUE, message=FALSE}
JSONurl_latlon_by_station_name <- bom_stations_raw[!is.na(bom_stations_raw$url), ]
devtools::use_data(JSONurl_latlon_by_station_name, overwrite = TRUE)
```

## Session Info
```{r session_info}
devtools::session_info()
```
